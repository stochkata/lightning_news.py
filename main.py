
from flask import Flask, render_template_string, request, jsonify, session
import requests
import qrcode
import io
import base64
import os
import time
import hashlib
import os
import urllib.parse
import json


app = Flask(__name__)

app.secret_key = os.getenv("FLASK_SECRET", "demo-lightning-network-implementation")
LNBITS_HOST = os.getenv("LNBITS_HOST", "https://demo.lnbits.com")
LNBITS_API_KEY = os.getenv("LNBITS_API_KEY", "f01f61a9421242e79f87c2337d8f7e64")
LOGIN_CHALLENGES = {}

HEADERS = {
    "X-Api-Key": LNBITS_API_KEY,
    "Content-type": "application/json"
}

ARTICLES = {
    1: {
        "title": "Bitcoin Lightning: –±—ä–¥–µ—â–µ—Ç–æ –Ω–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –ø–ª–∞—â–∞–Ω–∏—è—Ç–∞",
        "image": "images/ln.png",
        "preview": (
            "Lightning Network –ø—Ä–∞–≤–∏ –≤—ä–∑–º–æ–∂–Ω–∏ –º–∏–≥–Ω–æ–≤–µ–Ω–∏ –º–∏–∫—Ä–æ–ø–ª–∞—â–∞–Ω–∏—è —Å –ø–æ—á—Ç–∏ –Ω—É–ª–µ–≤–∏ —Ç–∞–∫—Å–∏. "
            "–¢–æ–≤–∞ –æ—Ç–≤–∞—Ä—è –≤—Ä–∞—Ç–∞—Ç–∞ –∑–∞ –Ω–∞–ø—ä–ª–Ω–æ –Ω–æ–≤ –º–æ–¥–µ–ª –Ω–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç ‚Äî –±–µ–∑ —Ä–µ–∫–ª–∞–º–∏, –±–µ–∑ –∞–±–æ–Ω–∞–º–µ–Ω—Ç–∏ "
            "–∏ –±–µ–∑ –ø–æ—Å—Ä–µ–¥–Ω–∏—Ü–∏."
        ),
        "full": (
            "Bitcoin Lightning Network –µ —Å–ª–æ–π –≤—ä—Ä—Ö—É Bitcoin, —Å—ä–∑–¥–∞–¥–µ–Ω —Å–ø–µ—Ü–∏–∞–ª–Ω–æ –∑–∞ –±—ä—Ä–∑–∏ –∏ "
            "–µ–≤—Ç–∏–Ω–∏ –ø–ª–∞—â–∞–Ω–∏—è. –í–º–µ—Å—Ç–æ –≤—Å—è–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –¥–∞ —á–∞–∫–∞ –ø–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ –≤ –±–ª–æ–∫—á–µ–π–Ω–∞, "
            "Lightning –ø–æ–∑–≤–æ–ª—è–≤–∞ –¥–∏—Ä–µ–∫—Ç–Ω–∏ –ø–ª–∞—â–∞–Ω–∏—è –º–µ–∂–¥—É –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏ –≤ —Ä–µ–∞–ª–Ω–æ –≤—Ä–µ–º–µ.\n\n"

            "–¢–æ–≤–∞ –ø—Ä–∞–≤–∏ –≤—ä–∑–º–æ–∂–Ω–∏ –º–∏–∫—Ä–æ–ø–ª–∞—â–∞–Ω–∏—è –æ—Ç –ø–æ—Ä—è–¥—ä–∫–∞ –Ω–∞ –Ω—è–∫–æ–ª–∫–æ —Å–∞—Ç–æ—à–∏ ‚Äî –Ω–µ—â–æ, –∫–æ–µ—Ç–æ "
            "–¥–æ—Å–µ–≥–∞ –±–µ—à–µ –∏–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏ –Ω–µ–≤—ä–∑–º–æ–∂–Ω–æ. –ö–æ–≥–∞—Ç–æ —Ç–∞–∫—Å–∞—Ç–∞ –µ –ø–æ—á—Ç–∏ –Ω—É–ª–∞, –º–æ–∂–µ—à –¥–∞ "
            "–ø–ª–∞—â–∞—à –∑–∞ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ —Ç–æ—á–Ω–æ –≤ –º–æ–º–µ–Ω—Ç–∞, –≤ –∫–æ–π—Ç–æ –≥–æ –∫–æ–Ω—Å—É–º–∏—Ä–∞—à.\n\n"

            "–í–º–µ—Å—Ç–æ –º–µ—Å–µ—á–Ω–∏ –∞–±–æ–Ω–∞–º–µ–Ω—Ç–∏ –∏–ª–∏ –Ω–∞—Ç—Ä–∞–ø—á–∏–≤–∏ —Ä–µ–∫–ª–∞–º–∏, –ø–ª–∞—â–∞—à 5 –∏–ª–∏ 10 —Å–∞—Ç–æ—à–∏, "
            "—Å–∞–º–æ –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—Ç–∞ —Å—Ç–∞—Ç–∏—è, –∫–æ—è—Ç–æ —á–µ—Ç–µ—à. –ë–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –±–µ–∑ –∫–∞—Ä—Ç–∞, "
            "–±–µ–∑ –¥–∞ –æ—Å—Ç–∞–≤—è—à –ª–∏—á–Ω–∏ –¥–∞–Ω–Ω–∏.\n\n"

            "Lightning –Ω–µ –µ –ø—Ä–æ—Å—Ç–æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–Ω–æ –ø–æ–¥–æ–±—Ä–µ–Ω–∏–µ. –¢–æ –ø—Ä–æ–º–µ–Ω—è –∏–∫–æ–Ω–æ–º–∏–∫–∞—Ç–∞ –Ω–∞ —É–µ–±–∞. "
            "–°—ä–¥—ä—Ä–∂–∞–Ω–∏–µ—Ç–æ –æ—Ç–Ω–æ–≤–æ –º–æ–∂–µ –¥–∞ —Å–µ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–∞ –¥–∏—Ä–µ–∫—Ç–Ω–æ –æ—Ç —á–∏—Ç–∞—Ç–µ–ª–∏—Ç–µ, –∞ –Ω–µ —á—Ä–µ–∑ "
            "–≤–Ω–∏–º–∞–Ω–∏–µ—Ç–æ –∏–º, –ø—Ä–æ–¥–∞–≤–∞–Ω–æ –Ω–∞ —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª–∏."
        )
    },
    2: {
        "title": "–ó–∞—â–æ —Ä–µ–∫–ª–∞–º–Ω–∏—è—Ç –º–æ–¥–µ–ª —É–º–∏—Ä–∞?",
        "image": "images/3.png",
        "preview": (
            "–†–µ–∫–ª–∞–º–∏—Ç–µ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–∞—Ç –º–æ–¥–µ—Ä–Ω–∏—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç, –Ω–æ –Ω–∞ —Ü–µ–Ω–∞—Ç–∞ –Ω–∞ –≤–Ω–∏–º–∞–Ω–∏–µ, "
            "–ª–∏—á–Ω–∏ –¥–∞–Ω–Ω–∏ –∏ –∫–∞—á–µ—Å—Ç–≤–æ. –¢–æ–∑–∏ –º–æ–¥–µ–ª –≤–µ—á–µ –ø–æ–∫–∞–∑–≤–∞ —Å–µ—Ä–∏–æ–∑–Ω–∏ –ø—É–∫–Ω–∞—Ç–∏–Ω–∏."
        ),
        "full": (
            "–†–µ–∫–ª–∞–º–Ω–∏—è—Ç –º–æ–¥–µ–ª –¥–æ–º–∏–Ω–∏—Ä–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –æ—Ç –¥–µ—Å–µ—Ç–∏–ª–µ—Ç–∏—è. –ü–æ—á—Ç–∏ –≤—Å–∏—á–∫–æ –µ ‚Äû–±–µ–∑–ø–ª–∞—Ç–Ω–æ‚Äú, "
            "–Ω–æ –≤ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–Ω–æ—Å—Ç –ø–ª–∞—â–∞–º–µ —Å –≤–Ω–∏–º–∞–Ω–∏–µ, –ª–∏—á–Ω–∏ –¥–∞–Ω–Ω–∏ –∏ –≤—Ä–µ–º–µ.\n\n"

            "–ó–∞ –¥–∞ –æ—Ü–µ–ª–µ—è—Ç, —Å–∞–π—Ç–æ–≤–µ—Ç–µ —Å–∞ –ø—Ä–∏–Ω—É–¥–µ–Ω–∏ –¥–∞ –≥–æ–Ω—è—Ç –∫–ª–∏–∫–æ–≤–µ, —Å–µ–Ω–∑–∞—Ü–∏–∏ –∏ –º–∞–∫—Å–∏–º–∞–ª–Ω–æ "
            "–≤—Ä–µ–º–µ –Ω–∞ –µ–∫—Ä–∞–Ω–∞. –¢–æ–≤–∞ –≤–æ–¥–∏ –¥–æ –Ω–∏—Å–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–æ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ, clickbait –∑–∞–≥–ª–∞–≤–∏—è "
            "–∏ –∞–≥—Ä–µ—Å–∏–≤–Ω–æ –ø—Ä–æ—Å–ª–µ–¥—è–≤–∞–Ω–µ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏—Ç–µ.\n\n"

            "–†–µ–∑—É–ª—Ç–∞—Ç—ä—Ç –µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç, –ø—ä–ª–µ–Ω —Å –±–∞–Ω–µ—Ä–∏, –ø–æ–ø—ä–ø–∏, –±–∏—Å–∫–≤–∏—Ç–∫–∏ –∏ —Å–∫—Ä–∏—Ç–∏ —Ç—Ä–∞–∫–µ—Ä–∏, "
            "–∫–æ–∏—Ç–æ –ø—Ä–∞–≤—è—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ—Ç–æ –∏–∑–∂–∏–≤—è–≤–∞–Ω–µ –≤—Å–µ –ø–æ-–ª–æ—à–æ. –ù–µ –µ —Å–ª—É—á–∞–π–Ω–æ, —á–µ "
            "ad-blocker-–∏—Ç–µ —Å–∞ –º–∞—Å–æ–≤–æ –∏–∑–ø–æ–ª–∑–≤–∞–Ω–∏.\n\n"

            "Lightning –ø—Ä–µ–¥–ª–∞–≥–∞ –∞–ª—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞. –í–º–µ—Å—Ç–æ 10 —Ä–µ–∫–ª–∞–º–∏ –∏ 20 —Ç—Ä–∞–∫–µ—Ä–∞, –ø–ª–∞—â–∞—à "
            "5 —Å–∞—Ç–æ—à–∏ –¥–∏—Ä–µ–∫—Ç–Ω–æ –Ω–∞ –∞–≤—Ç–æ—Ä–∞. –ë–µ–∑ –ø–æ—Å—Ä–µ–¥–Ω–∏—Ü–∏. –ë–µ–∑ –¥–∞ –±—ä–¥–µ—à –ø—Ä–æ–¥—É–∫—Ç—ä—Ç.\n\n"

            "–ö–æ–≥–∞—Ç–æ –ø–ª–∞—â–∞–Ω–µ—Ç–æ –µ –ª–µ—Å–Ω–æ, –µ–≤—Ç–∏–Ω–æ –∏ –º–æ–º–µ–Ω—Ç–∞–ª–Ω–æ, —Ä–µ–∫–ª–∞–º–Ω–∏—è—Ç –º–æ–¥–µ–ª –≥—É–±–∏ "
            "–æ—Å–Ω–æ–≤–Ω–æ—Ç–æ —Å–∏ –ø—Ä–µ–¥–∏–º—Å—Ç–≤–æ. –ò —Ç–æ—á–Ω–æ –∑–∞—Ç–æ–≤–∞ —Ç–æ–π –±–∞–≤–Ω–æ, –Ω–æ —Å–∏–≥—É—Ä–Ω–æ —É–º–∏—Ä–∞."
        )
    },
    3: {
        "title": "–ë–∏—Ç–∫–æ–π–Ω: –¢–≤—ä—Ä–¥–∏ –ø–∞—Ä–∏ –≤ —Å–≤—è—Ç –Ω–∞ –∏–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∞ –Ω–µ—Å–∏–≥—É—Ä–Ω–æ—Å—Ç",
        "image": "images/bitcoin.png",
        "preview": (
            "–¶—è–ª –∂–∏–≤–æ—Ç –ø—Ä–æ–¥–∞–≤–∞–º–µ –≤—Ä–µ–º–µ—Ç–æ —Å–∏ –∑–∞ –ø–∞—Ä–∏, –Ω–æ –º–∞–ª—Ü–∏–Ω–∞ —Ä–∞–∑–±–∏—Ä–∞—Ç –∫–∞–∫–≤–æ –≤—Å—ä—â–Ω–æ—Å—Ç —Å–∞ —Ç–µ. "
            "–ü–∞—Ä–∏—Ç–µ –Ω–µ —Å–∞ –ø—Ä–æ—Å—Ç–æ –±–∞–Ω–∫–Ω–æ—Ç–∏ –∏ —Ü–∏—Ñ—Ä–∏ –≤ –±–∞–Ω–∫–∞ ‚Äî —Ç–µ —Å–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è –∑–∞ –ø—Ä–µ–Ω–∞—Å—è–Ω–µ –Ω–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç "
            "–≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ—Ç–æ –∏ –≤—Ä–µ–º–µ—Ç–æ. –†–∞–±–æ—Ç–∏ –ª–∏ –¥–Ω–µ—à–Ω–∞—Ç–∞ –ø–∞—Ä–∏—á–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –≤ –Ω–∞—à–∞ –ø–æ–ª–∑–∞‚Ä¶ –∏–ª–∏ —Å—Ä–µ—â—É –Ω–∞—Å?"
        ),
        "full": (
            "–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏ —Ç–≤—ä—Ä–¥–∏—Ç–µ –ø–∞—Ä–∏, –∫–∞—Ç–æ –∑–ª–∞—Ç–æ—Ç–æ, –ø—Ä–µ–¥–ª–∞–≥–∞—Ç —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç, –∑–∞—â–æ—Ç–æ —Å–∞ —Ä–µ–¥–∫–∏ –∏ "
            "—Ç—Ä—É–¥–Ω–æ —Å–µ –¥–æ–±–∏–≤–∞—Ç. –¢–µ –Ω–µ –º–æ–≥–∞—Ç –¥–∞ –±—ä–¥–∞—Ç —Å—ä–∑–¥–∞–¥–µ–Ω–∏ –æ—Ç –Ω–∏—â–æ—Ç–æ ‚Äî –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –µ –µ–Ω–µ—Ä–≥–∏—è, "
            "–≤—Ä–µ–º–µ –∏ —Ç—Ä—É–¥, –∑–∞ –¥–∞ –ø—Ä–∏–¥–æ–±–∏—è—Ç —Å—Ç–æ–π–Ω–æ—Å—Ç.\n\n"
            "–§–∏–∞—Ç–Ω–∏—Ç–µ –≤–∞–ª—É—Ç–∏, –∫–æ–∏—Ç–æ –¥–æ–º–∏–Ω–∏—Ä–∞—Ç –¥–Ω–µ—Å (–¥–æ–ª–∞—Ä, –µ–≤—Ä–æ, –ª–µ–≤ –∏ –¥—Ä—É–≥–∏), –Ω—è–º–∞—Ç –≤—ä—Ç—Ä–µ—à–Ω–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç. "
            "–¢–µ —Å–∞ –ø–∞—Ä–∏ –ø–æ –Ω–∞—Ä–µ–∂–¥–∞–Ω–µ ‚Äî —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—Ç, –∑–∞—â–æ—Ç–æ –ø—Ä–∞–≤–∏—Ç–µ–ª—Å—Ç–≤–∞—Ç–∞ –∑–∞—è–≤—è–≤–∞—Ç, —á–µ –∏–º–∞—Ç —Å—Ç–æ–π–Ω–æ—Å—Ç, "
            "–∞ —Ö–æ—Ä–∞—Ç–∞ —Å–∞ –ø—Ä–∏–Ω—É–¥–µ–Ω–∏ –¥–∞ –∏–º –≤—è—Ä–≤–∞—Ç. –ó–∞ —Ä–∞–∑–ª–∏–∫–∞ –æ—Ç –∑–ª–∞—Ç–æ—Ç–æ, —Ç—è—Ö–Ω–æ—Ç–æ –ø—Ä–µ–¥–ª–∞–≥–∞–Ω–µ –º–æ–∂–µ –¥–∞ –±—ä–¥–µ "
            "—É–≤–µ–ª–∏—á–∞–≤–∞–Ω–æ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –æ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–Ω–∏—Ç–µ –±–∞–Ω–∫–∏, –∫–æ–µ—Ç–æ –≤–æ–¥–∏ –¥–æ –∏–Ω—Ñ–ª–∞—Ü–∏—è –∏ —Å–µ—Ä–∏–æ–∑–Ω–∏ "
            "–∏–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏ –∏–∑–∫—Ä–∏–≤—è–≤–∞–Ω–∏—è.\n\n"
            "–û—Ç—Ç–∞–º –∏–¥–≤–∞ –∏ –ø—Ä–æ–±–ª–µ–º—ä—Ç —Å —Ç—è—Ö. –¶–µ–Ω—Ç—Ä–∞–ª–Ω–∏—Ç–µ –±–∞–Ω–∫–∏ –∏–º–∞—Ç –ø—Ä–∞–≤–æ—Ç–æ –¥–∞ —Å—ä–∑–¥–∞–≤–∞—Ç –Ω–æ–≤–∏ –ø–∞—Ä–∏ —á—Ä–µ–∑ –¥—ä–ª–≥."
            "–ö–æ–≥–∞—Ç–æ –ø—Ä–∞–≤–∏—Ç–µ–ª—Å—Ç–≤–∞—Ç–∞ –∏–∑–¥–∞–≤–∞—Ç –æ–±–ª–∏–≥–∞—Ü–∏–∏, —Ü–µ–Ω—Ç—Ä–∞–ª–Ω–∞—Ç–∞ –±–∞–Ω–∫–∞ –≥–∏ –∏–∑–∫—É–ø—É–≤–∞ —Å –Ω–æ–≤–æ—Å—ä–∑–¥–∞–¥–µ–Ω–∏ –ø–∞—Ä–∏, "
            "—É–≤–µ–ª–∏—á–∞–≤–∞–π–∫–∏ –ø–∞—Ä–∏—á–Ω–æ—Ç–æ –ø—Ä–µ–¥–ª–∞–≥–∞–Ω–µ. –¢–æ–≤–∞ –æ–∑–Ω–∞—á–∞–≤–∞, —á–µ —Å—Ç–æ–π–Ω–æ—Å—Ç—Ç–∞ –Ω–∞ —Å–ø–µ—Å—Ç—è–≤–∞–Ω–∏—è—Ç–∞ –≤–∏ –Ω–∞–º–∞–ª—è–≤–∞ –≤—Å–µ–∫–∏ "
            "–ø—ä—Ç, –∫–æ–≥–∞—Ç–æ —Å–µ –æ—Ç–ø–µ—á–∞—Ç–∞—Ç –Ω–æ–≤–∏ –ø–∞—Ä–∏.\n\n"
            "–ü—Ä–µ–¥—Å—Ç–∞–≤–µ—Ç–µ —Å–∏ —Å–µ–ª–æ —Å –µ–¥–∏–Ω –ø–µ–∫–∞—Ä, –∫–æ–π—Ç–æ –ø—Ä–æ–∏–∑–≤–µ–∂–¥–∞ 100 —Ö–ª—è–±–∞ –¥–Ω–µ–≤–Ω–æ –Ω–∞ —Ü–µ–Ω–∞ 1 –ª–µ–≤. "
            "–ê–∫–æ –≤–Ω–µ–∑–∞–ø–Ω–æ –≤ –æ–±—Ä–∞—â–µ–Ω–∏–µ —Å–µ –ø–æ—è–≤—è—Ç –æ—â–µ 100 –ª–µ–≤–∞ –±–µ–∑ –ø–æ–≤–µ—á–µ —Ö–ª—è–±, —Ü–µ–Ω–∞—Ç–∞ –ª–æ–≥–∏—á–Ω–æ —Å–µ "
            "—É–¥–≤–æ—è–≤–∞. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ—Ç–æ –ø–∞—Ä–∏ —Ä–∞—Å—Ç–µ, –Ω–æ —Ä–µ–∞–ª–Ω–æ—Ç–æ –±–æ–≥–∞—Ç—Å—Ç–≤–æ –Ω–µ.\n\n"

            "–ò–Ω—Ñ–ª–∞—Ü–∏—è—Ç–∞ –µ —Ç–∏—Ö–∏—è—Ç –∫—Ä–∞–¥–µ—Ü. –¢—è –Ω–µ –æ—Ç–Ω–µ–º–∞ –ø–∞—Ä–∏ –¥–∏—Ä–µ–∫—Ç–Ω–æ, –∞ –Ω–∞–º–∞–ª—è–≤–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª–Ω–∞—Ç–∞ –∏–º "
            "—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç –≤—ä–≤ –≤—Ä–µ–º–µ—Ç–æ. –•–ª—è–±, –º–ª—è–∫–æ, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –∫–∞—Ñ–µ, –µ–Ω–µ—Ä–≥–∏—è ‚Äî –≤—Å–∏—á–∫–æ –ø–æ—Å–∫—ä–ø–≤–∞, "
            "–∑–∞—â–æ—Ç–æ –≤–∞–ª—É—Ç–∞—Ç–∞ —Å–µ –æ–±–µ–∑—Ü–µ–Ω—è–≤–∞.\n\n"

            "–õ–∏–ø—Å–∞—Ç–∞ –Ω–∞ —Å—Ç–∏–º—É–ª –∑–∞ —Å–ø–µ—Å—Ç—è–≤–∞–Ω–µ –ø—Ä–∏–Ω—É–∂–¥–∞–≤–∞ —Ö–æ—Ä–∞—Ç–∞ –¥–∞ –ø–æ–µ–º–∞—Ç —Ä–∏—Å–∫, –≤–º–µ—Å—Ç–æ –¥–∞ –≥—Ä–∞–¥—è—Ç. "
            "–í–º–µ—Å—Ç–æ –¥–∞ —Å–µ —Ñ–æ–∫—É—Å–∏—Ä–∞—Ç –≤—ä—Ä—Ö—É –ø—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–Ω–æ—Ç–æ —Å–∏ —Ä–∞–∑–≤–∏—Ç–∏–µ, —Ç–µ —Å–∞ –ø—Ä–∏–Ω—É–¥–µ–Ω–∏ –¥–∞ —Ç—ä—Ä—Å—è—Ç "
            "–Ω–∞—á–∏–Ω–∏ –¥–∞ –∑–∞—â–∏—Ç—è—Ç —Å–ø–µ—Å—Ç—è–≤–∞–Ω–∏—è—Ç–∞ —Å–∏.\n\n"

            "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–Ω–∏—è—Ç –Ω–∞–ø—Ä–µ–¥—ä–∫ –ø—Ä–∞–≤–∏ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ—Ç–æ –ø–æ-–µ–≤—Ç–∏–Ω–æ –∏ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ, –Ω–æ —Ü–µ–Ω–∏—Ç–µ –Ω–µ –ø–∞–¥–∞—Ç. "
            "–ü—Ä–∏—á–∏–Ω–∞—Ç–∞ –Ω–µ –µ –ª–∏–ø—Å–∞—Ç–∞ –Ω–∞ –Ω–∞–ø—Ä–µ–¥—ä–∫, –∞ –ø–∞—Ä–∏—á–Ω–∞—Ç–∞ —Å–∏—Å—Ç–µ–º–∞, –∫–æ—è—Ç–æ –Ω–µ –¥–æ–ø—É—Å–∫–∞ –¥–µ—Ñ–ª–∞—Ü–∏—è, "
            "–∑–∞ –¥–∞ –∑–∞—â–∏—Ç–∏ –¥—ä–ª–≥–æ–≤–µ—Ç–µ.\n\n"

            "–ë–∏—Ç–∫–æ–π–Ω –∏–º–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ –ø—Ä–µ–¥–ª–∞–≥–∞–Ω–µ –æ—Ç 21 –º–∏–ª–∏–æ–Ω–∞ –µ–¥–∏–Ω–∏—Ü–∏ ‚Äî –ø—Ä–∞–≤–∏–ª–æ, –∑–∞–ª–æ–∂–µ–Ω–æ –≤ –∫–æ–¥–∞ –∏ "
            "–∑–∞—â–∏—Ç–µ–Ω–æ –æ—Ç –¥–µ—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–∏—Ä–∞–Ω–∞ –º—Ä–µ–∂–∞. –ù–∏–∫–æ–π –Ω–µ –º–æ–∂–µ –¥–∞ –≥–æ –ø—Ä–æ–º–µ–Ω–∏ –µ–¥–Ω–æ–ª–∏—á–Ω–æ.\n\n"

            "–¢–æ–≤–∞ –≥–æ –ø—Ä–∞–≤–∏ —Ñ–æ—Ä–º–∞ –Ω–∞ —Ç–≤—ä—Ä–¥–∏ –ø–∞—Ä–∏, —É—Å—Ç–æ–π—á–∏–≤–∞ –Ω–∞ –∏–Ω—Ñ–ª–∞—Ü–∏—è –∏ —Ü–µ–Ω–∑—É—Ä–∞. –° –≤—Ä–µ–º–µ—Ç–æ —Ç–æ–π —Å–µ "
            "—É—Ç–≤—ä—Ä–∂–¥–∞–≤–∞ –∫–∞—Ç–æ –¥–∏–≥–∏—Ç–∞–ª–Ω–æ –∑–ª–∞—Ç–æ ‚Äî —Å—Ä–µ–¥—Å—Ç–≤–æ –∑–∞ —Å—ä—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç –≤ —Ü–∏—Ñ—Ä–æ–≤–∏—è —Å–≤—è—Ç.\n\n"

            "–¢–≤—ä—Ä–¥–∏—Ç–µ –ø–∞—Ä–∏ –Ω–∞—Å—ä—Ä—á–∞–≤–∞—Ç –¥—ä–ª–≥–æ—Å—Ä–æ—á–Ω–æ –º–∏—Å–ª–µ–Ω–µ. –ö–æ–≥–∞—Ç–æ —Å—Ç–æ–π–Ω–æ—Å—Ç—Ç–∞ –Ω–µ —Å–µ —Ä–∞–∑–º–∏–≤–∞, —Ö–æ—Ä–∞—Ç–∞ "
            "–º–æ–≥–∞—Ç –¥–∞ –ø–ª–∞–Ω–∏—Ä–∞—Ç, –¥–∞ —Å–ø–µ—Å—Ç—è–≤–∞—Ç –∏ –¥–∞ –≥—Ä–∞–¥—è—Ç –±—ä–¥–µ—â–µ.\n\n"

            "–§–∏–∞—Ç–Ω–∏—Ç–µ –≤–∞–ª—É—Ç–∏ —Å–∞ –≤ –æ—Å–Ω–æ–≤–∞—Ç–∞ –Ω–∞ –º–Ω–æ–≥–æ –æ—Ç –¥–Ω–µ—à–Ω–∏—Ç–µ –∏–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏ –ø—Ä–æ–±–ª–µ–º–∏. "
            "–ë–∏—Ç–∫–æ–π–Ω –ø—Ä–µ–¥–ª–∞–≥–∞ –∞–ª—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ ‚Äî —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞ —Å—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç, —Å—Ç–∞–±–∏–ª–Ω–æ—Å—Ç –∏ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç "
            "–≤ –µ–¥–∏–Ω –≤—Å–µ –ø–æ-–Ω–µ—Å–∏–≥—É—Ä–µ–Ω —Å–≤—è—Ç."
            )
        },
}


def make_qr_image(data):
    qr = qrcode.QRCode(version=1, box_size=8, border=2)
    qr.add_data(data)
    qr.make(fit=True)
    img = qr.make_image(fill="black", back_color="white")

    buf = io.BytesIO()
    img.save(buf, format="PNG")
    return base64.b64encode(buf.getvalue()).decode()


@app.route("/")
def index():
    html = """
    <html>
<head>
    <title>Lightning News Demo</title>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
 body {
    font-family: "Inter", sans-serif;
    margin: 0;
    padding: 0;
    background: #0f1115;
    color: #e5e7eb;
}

.header {
    background: #14171c;
    padding: 24px 40px;
    border-bottom: 1px solid #23262d;
    display: flex;
    align-items: center;
    gap: 18px;
}

.logo {
    font-size: 72px;
}

.title-text {
    font-size: 38px;
    font-weight: 700;
    color: #f7931a;
}

.subtitle {
    font-size: 22px;
    color: #9ca3af;
    margin-top: -4px;
}

.container {
    max-width: 900px;
    margin: 50px auto;
    padding: 20px;
}

.article {
    background: #14171c;
    padding: 28px;
    margin-bottom: 40px;
    border-radius: 16px;
    border: 1px solid #23262d;
    box-shadow: 0 10px 30px rgba(0,0,0,0.4);
}

.article-image {
    width: 100%;
    height: auto;
    border-radius: 14px;
    margin-bottom: 18px;
}

h2 {
    font-size: 24px;
    margin-bottom: 12px;
    font-weight: 700;
    color: #f9fafb;
}

p {
    font-size: 16px;
    line-height: 1.6;
    color: #d1d5db;
}

button {
    padding: 14px 22px;
    background: linear-gradient(135deg, #f7931a, #ffb347);
    color: #111;
    border: none;
    font-weight: 700;
    border-radius: 10px;
    margin-top: 14px;
    cursor: pointer;
    font-size: 15px;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
}

button:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(247,147,26,0.35);
}

.qr-box {
    margin-top: 18px;
    padding: 20px;
    background: #0f1115;
    border: 1px dashed #2a2e37;
    border-radius: 14px;
    text-align: center;
    color: #9ca3af;
}

      

    </style>
</head>

<body>

    <div class="header">
        <div class="logo">‚ö°</div>
        <div>
            <div class="title-text">BitReads</div>
            <div class="subtitle">–ß–µ—Ç–∏ –±–µ–∑ –∞–∫–∞—É–Ω—Ç ‚Äî –ø—ä–ª–Ω–∏—è—Ç —Ç–µ–∫—Å—Ç —Å–µ –æ—Ç–∫–ª—é—á–≤–∞ —Å LN ‚ö°</div>
        </div>
    </div>

    <div class="container">
        {% for id, art in articles.items() %}
            <div class="article">
            <img src="{{ url_for('static', filename=art.image) }}" class="article-image">
                <h2>{{ art.title }}</h2>
                <p>{{ art.preview }}</p>

                <div id="full{{id}}"></div>

                <button id="btn{{id}}" onclick="unlock({{id}})">üîì –û—Ç–∫–ª—é—á–∏ –ø—ä–ª–Ω–∏—è —Ç–µ–∫—Å—Ç (5 sats)</button>
            </div>
        {% endfor %}
    </div>

    <script>
    function unlock(id) {
        const btn = document.getElementById("btn" + id);
        const full = document.getElementById("full" + id);

        btn.style.display = "none";

        fetch("/create_invoice/" + id)
            .then(r => r.json())
            .then(data => {
                full.innerHTML = `
                    <div class="qr-box">
                        <p><b>–°–∫–∞–Ω–∏—Ä–∞–π QR –∑–∞ –ø–ª–∞—â–∞–Ω–µ:</b></p>
                        <img src="data:image/png;base64,${data.qr}" width="200"><br>
                        <p><i>–ò–∑—á–∞–∫–≤–∞ —Å–µ –ø–ª–∞—â–∞–Ω–µ...</i></p>
                        <button onclick="cancelPayment(${id})" 
                                style="background:#ddd;margin-top:10px;">
                            ‚ùå –û—Ç–∫–∞–∂–∏ –ø–ª–∞—â–∞–Ω–µ—Ç–æ
                        </button>
                    </div>
                `;

                // POLLING
                let interval = setInterval(() => {
                    fetch("/check_payment/" + data.payment_hash)
                        .then(r => r.json())
                        .then(st => {
                            if (st.paid) {
                                clearInterval(interval);

                                fetch("/full_article/" + id)
                                    .then(r=>r.json())
                                    .then(info => {
                                        full.innerHTML = "<p>"+info.full+"</p>";
                                    });
                            }
                        });
                }, 1500);

                full.dataset.interval = interval;
            });
    }

    function cancelPayment(id) {
        const full = document.getElementById("full" + id);
        const btn = document.getElementById("btn" + id);

        // –°–ø–∏—Ä–∞–º–µ polling-a
        const interval = full.dataset.interval;
        if (interval) clearInterval(interval);

        // –ü–æ—á–∏—Å—Ç–≤–∞–º–µ QR –∫—É—Ç–∏—è—Ç–∞
        full.innerHTML = "";

        // –í—Ä—ä—â–∞–º–µ –±—É—Ç–æ–Ω–∞
        btn.style.display = "inline-block";
    }
    function loginLN() {
    fetch("/login")
        .then(r => r.json())
        .then(data => {
            alert("Scan QR with your Lightning wallet");

            document.body.innerHTML += `
                <div class="qr-box">
                    <img src="data:image/png;base64,${data.qr}" width="220">
                </div>
            `;

            pollLogin();
        });
}

function pollLogin() {
    setInterval(() => {
        fetch("/me")
            .then(r => r.json())
            .then(u => {
                if (u.logged_in) {
                    location.reload();
                }
            });
    }, 1500);
}
</script>

</body>
</html>
"""

    return render_template_string(html, articles=ARTICLES)


@app.route("/create_invoice/<int:article_id>")
def create_invoice(article_id):
    payload = { "out": False, "amount": 5, "memo": f"Unlock article {article_id}", "expiry": 86400 }
    r = requests.post(f"{LNBITS_HOST}/api/v1/payments", json=payload, headers=HEADERS).json()
    qr = make_qr_image(r["payment_request"])
    
    return jsonify({
        "pr": r["payment_request"],
        "payment_hash": r["payment_hash"],
        "qr": qr
    })


@app.route("/check_payment/<payment_hash>")
def check_payment(payment_hash):
    r = requests.get(f"{LNBITS_HOST}/api/v1/payments/{payment_hash}", headers=HEADERS).json()
    return jsonify({"paid": r.get("paid", False)})


@app.route("/full_article/<int:article_id>")
def full_article(article_id):
    return jsonify({"full": ARTICLES[article_id]["full"]})


if __name__ == "__main__":
    app.run(debug=True)

